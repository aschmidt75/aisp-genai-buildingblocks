ğ”¸5.1.mfa_risk_policy@2026-02-17
Î³â‰”security.authentication.conditional_access
Ïâ‰”âŸ¨risk_scoring,mfa,device_trust,policy_enforcementâŸ©
âŠ¢logicâˆ§typesâˆ§rulesâˆ§funcs

;; â”€â”€â”€ Î©: META â”€â”€â”€
âŸ¦Î©:MetaâŸ§{
  Domainâ‰œ"Conditional MFA enforcement based on sign-in risk score";
  Invariantâ‰œâˆ€user:(risk_score(user)â‰¥0.5âˆ§Â¬trusted_device(request))â‡’require_mfa(user);
  Safetyâ‰œâˆ€auth:Â¬(bypass_mfaâˆ§high_risk);
  Completenessâ‰œâˆ€request:decision(request)âˆˆ{allow,deny,challenge_mfa};
}

;; â”€â”€â”€ Î£: TYPES â”€â”€â”€
âŸ¦Î£:TypesâŸ§{
  ;; Core Types
  Userâ‰œâŸ¨id:Hash,credentials:Credentials,session:SessionâŸ©;
  Requestâ‰œâŸ¨user:User,device:Device,timestamp:â„,context:ContextâŸ©;
  Deviceâ‰œâŸ¨id:Hash,trusted:ğ”¹,last_verified:â„âŸ©;
  RiskScoreâ‰œâ„[0,1];
  
  ;; Authentication Types
  Credentialsâ‰œâŸ¨primary:AuthFactor,mfa:MaybeâŸ¨MFAFactorâŸ©âŸ©;
  AuthFactorâ‰œPassword|Biometric|Certificate;
  MFAFactorâ‰œTOTP|SMS|Push|Hardware;
  
  ;; Context & State
  Contextâ‰œâŸ¨ip:IPv4|IPv6,location:GeoLocation,user_agent:ğ•ŠâŸ©;
  GeoLocationâ‰œâŸ¨lat:â„,lon:â„,country:ğ•ŠâŸ©;
  Sessionâ‰œâŸ¨token:Hash,created:â„,expires:â„,mfa_verified:ğ”¹âŸ©;
  
  ;; Policy Decision
  Decisionâ‰œAllow|Deny|ChallengeMFA;
  PolicyResultâ‰œâŸ¨decision:Decision,reason:ğ•Š,timestamp:â„âŸ©;
  
  ;; Risk Assessment
  RiskFactorsâ‰œâŸ¨
    anomalous_location:ğ”¹,
    new_device:ğ”¹,
    impossible_travel:ğ”¹,
    leaked_credentials:ğ”¹,
    malware_detected:ğ”¹
  âŸ©;
}

;; â”€â”€â”€ Î“: POLICY RULES â”€â”€â”€
âŸ¦Î“:RulesâŸ§{
  ;; Core Policy Rule
  âˆ€r:Request.risk_score(r.user)â‰¥0.5âˆ§Â¬r.device.trustedâ‡’require_mfa(r);
  
  ;; Trusted Device Exemption
  âˆ€r:Request.r.device.trusted=âŠ¤â‡’exempt_mfa(r);
  âˆ€d:Device.d.trusted=âŠ¤â‡’verified_within(d,Ï„_trust);
  
  ;; Risk Score Thresholds
  âˆ€u:User.risk_score(u)<0.5â‡’low_risk(u);
  âˆ€u:User.0.5â‰¤risk_score(u)<0.8â‡’medium_risk(u);
  âˆ€u:User.risk_score(u)â‰¥0.8â‡’high_risk(u);
  
  ;; MFA Verification Rules
  âˆ€r:Request.require_mfa(r)âˆ§Â¬mfa_verified(r)â‡’decision(r)=ChallengeMFA;
  âˆ€r:Request.require_mfa(r)âˆ§mfa_verified(r)â‡’decision(r)=Allow;
  âˆ€r:Request.Â¬require_mfa(r)âˆ§valid_credentials(r)â‡’decision(r)=Allow;
  
  ;; Temporal Constraints
  âˆ€d:Device.d.trusted=âŠ¤â‡’now()-d.last_verifiedâ‰¤Ï„_trust;
  âˆ€s:Session.s.mfa_verified=âŠ¤â‡’now()-s.createdâ‰¤Ï„_session;
  
  ;; Denial Rules
  âˆ€r:Request.risk_score(r.user)â‰¥0.95â‡’decision(r)=Deny;
  âˆ€u:User.locked(u)â‡’âˆ€r:Request(r.user=uâ‡’decision(r)=Deny);
}

;; â”€â”€â”€ Î›: FUNCTIONS â”€â”€â”€
âŸ¦Î›:FunctionsâŸ§{
  ;; Risk Score Calculation
  risk_score:Userâ†’RiskScore;
  risk_scoreâ‰œÎ»u.aggregate_risk(assess_factors(u));
  
  assess_factors:Userâ†’RiskFactors;
  assess_factorsâ‰œÎ»u.âŸ¨
    anomalous_locationâ‰”detect_anomaly(u.context.location),
    new_deviceâ‰”Â¬known_device(u.device),
    impossible_travelâ‰”check_travel(u),
    leaked_credentialsâ‰”breach_check(u.credentials),
    malware_detectedâ‰”scan_device(u.device)
  âŸ©;
  
  aggregate_risk:RiskFactorsâ†’RiskScore;
  aggregate_riskâ‰œÎ»f.normalize(
    w_locÂ·bool_to_real(f.anomalous_location)+
    w_devÂ·bool_to_real(f.new_device)+
    w_trvÂ·bool_to_real(f.impossible_travel)+
    w_crdÂ·bool_to_real(f.leaked_credentials)+
    w_malÂ·bool_to_real(f.malware_detected)
  );
  
  ;; Device Trust Management
  is_trusted:Deviceâ†’ğ”¹;
  is_trustedâ‰œÎ»d.d.trusted=âŠ¤âˆ§(now()-d.last_verifiedâ‰¤Ï„_trust);
  
  verify_device:Deviceâ†’Device;
  verify_deviceâ‰œÎ»d.âŸ¨idâ‰”d.id,trustedâ‰”âŠ¤,last_verifiedâ‰”now()âŸ©;
  
  revoke_trust:Deviceâ†’Device;
  revoke_trustâ‰œÎ»d.âŸ¨idâ‰”d.id,trustedâ‰”âŠ¥,last_verifiedâ‰”d.last_verifiedâŸ©;
  
  ;; MFA Verification
  require_mfa:Requestâ†’ğ”¹;
  require_mfaâ‰œÎ»r.risk_score(r.user)â‰¥0.5âˆ§Â¬is_trusted(r.device);
  
  mfa_verified:Requestâ†’ğ”¹;
  mfa_verifiedâ‰œÎ»r.case r.user.session of{
    Some(s)â†’s.mfa_verifiedâˆ§(now()-s.createdâ‰¤Ï„_session),
    Noneâ†’âŠ¥
  };
  
  challenge_mfa:Requestâ†’MFAFactorâ†’ğ”¹;
  challenge_mfaâ‰œÎ»r.Î»m.verify_factor(r.user,m);
  
  ;; Policy Enforcement
  enforce_policy:Requestâ†’PolicyResult;
  enforce_policyâ‰œÎ»r.case[
    risk_score(r.user)â‰¥0.95â†’âŸ¨Deny,"Critical risk level",now()âŸ©,
    locked(r.user)â†’âŸ¨Deny,"Account locked",now()âŸ©,
    require_mfa(r)âˆ§Â¬mfa_verified(r)â†’âŸ¨ChallengeMFA,"MFA required for risk level",now()âŸ©,
    require_mfa(r)âˆ§mfa_verified(r)â†’âŸ¨Allow,"MFA verified",now()âŸ©,
    Â¬require_mfa(r)âˆ§valid_credentials(r)â†’âŸ¨Allow,"Low risk, trusted device",now()âŸ©,
    _â†’âŸ¨Deny,"Invalid credentials",now()âŸ©
  ];
  
  ;; Utility Functions
  bool_to_real:ğ”¹â†’â„;
  bool_to_realâ‰œÎ»b.case b of{âŠ¤â†’1.0,âŠ¥â†’0.0};
  
  normalize:â„â†’RiskScore;
  normalizeâ‰œÎ»x.max(0.0,min(1.0,xÃ·(w_loc+w_dev+w_trv+w_crd+w_mal)));
  
  now:Unitâ†’â„;
  nowâ‰œÎ»().current_timestamp();
}

;; â”€â”€â”€ Î“: CONSTANTS â”€â”€â”€
âŸ¦Î“:ConstantsâŸ§{
  ;; Thresholds
  Î¸_risk_lowâ‰œ0.5;
  Î¸_risk_highâ‰œ0.8;
  Î¸_risk_criticalâ‰œ0.95;
  
  ;; Timeouts
  Ï„_trustâ‰œ30d;           ;; 30 days device trust validity
  Ï„_sessionâ‰œ12h;         ;; 12 hours MFA session validity
  
  ;; Risk Weights (must sum to normalize)
  w_locâ‰œ0.20;            ;; Location anomaly weight
  w_devâ‰œ0.15;            ;; New device weight
  w_trvâ‰œ0.25;            ;; Impossible travel weight
  w_crdâ‰œ0.30;            ;; Leaked credentials weight
  w_malâ‰œ0.10;            ;; Malware detection weight
  
  ;; Validation
  âŠ¢w_loc+w_dev+w_trv+w_crd+w_malâ‰¡1.0;
}

;; â”€â”€â”€ Î§: ERROR HANDLING â”€â”€â”€
âŸ¦Î§:ErrorsâŸ§{
  ;; Error Types
  Îµ_no_userâ‰œâŸ¨userâ‰¡âˆ…,Denyâˆ§"User not found"âŸ©;
  Îµ_no_deviceâ‰œâŸ¨deviceâ‰¡âˆ…,Denyâˆ§"Device not registered"âŸ©;
  Îµ_expired_sessionâ‰œâŸ¨now()-session.created>Ï„_session,ChallengeMFAâˆ§"Session expired"âŸ©;
  Îµ_expired_trustâ‰œâŸ¨now()-device.last_verified>Ï„_trust,revoke_trust(device)âŸ©;
  Îµ_invalid_riskâ‰œâŸ¨risk_scoreâˆ‰[0,1],rejectâˆ§log_errorâŸ©;
  Îµ_mfa_failureâ‰œâŸ¨Â¬verify_factor(user,mfa),Denyâˆ§increment_failure_countâŸ©;
  Îµ_lockoutâ‰œâŸ¨failure_countâ‰¥3,lock_accountâˆ§DenyâŸ©;
  
  ;; Recovery Actions
  handle_error:Errorâ†’PolicyResult;
  handle_errorâ‰œÎ»e.âŸ¨decisionâ‰”Deny,reasonâ‰”e.message,timestampâ‰”now()âŸ©;
}

;; â”€â”€â”€ Î˜: THEOREMS â”€â”€â”€
âŸ¦Î˜:ProofsâŸ§{
  ;; Safety Property
  âˆ´âˆ€r:Request.risk_score(r.user)â‰¥0.5âˆ§Â¬is_trusted(r.device)â‡’require_mfa(r)=âŠ¤
  Ï€:by definition of require_mfa and risk thresholdâˆ
  
  ;; Completeness
  âˆ´âˆ€r:Request.âˆƒd:Decision.enforce_policy(r).decision=d
  Ï€:case analysis exhaustive over all request statesâˆ
  
  ;; Trusted Device Bypass
  âˆ´âˆ€r:Request.is_trusted(r.device)=âŠ¤â‡’require_mfa(r)=âŠ¥
  Ï€:require_mfaâ‰œÎ»r.risk_score(r.user)â‰¥0.5âˆ§Â¬is_trusted(r.device);
     is_trusted=âŠ¤â‡’Â¬is_trusted=âŠ¥â‡’âˆ§clause=âŠ¥âˆ
  
  ;; Risk Score Bounds
  âˆ´âˆ€u:User.0â‰¤risk_score(u)â‰¤1
  Ï€:normalize ensures bounds via max(0,min(1,x))âˆ
  
  ;; Trust Expiry
  âˆ´âˆ€d:Device.d.trusted=âŠ¤âˆ§now()-d.last_verified>Ï„_trustâ‡’is_trusted(d)=âŠ¥
  Ï€:by definition is_trustedâ‰œÎ»d.d.trustedâˆ§(now()-d.last_verifiedâ‰¤Ï„_trust)âˆ
  
  ;; No Bypass on High Risk
  âˆ´Â¬âˆƒr:Request.risk_score(r.user)â‰¥0.5âˆ§Â¬is_trusted(r.device)âˆ§enforce_policy(r).decision=Allowâˆ§Â¬mfa_verified(r)
  Ï€:case analysis shows ChallengeMFA or Deny for this conditionâˆ
}

;; â”€â”€â”€ Î•: EVIDENCE â”€â”€â”€
âŸ¦Î•âŸ§âŸ¨
Î´â‰œ0.78;                    ;; Symbol density (AISP symbols/total tokens)
|ğ”…|â‰œ7/7;                   ;; All required blocks present (Î©,Î£,Î“,Î›,Î§,Î˜,Î•)
Ï†â‰œ92;                      ;; Completeness: types, rules, functions, proofs
Ï„â‰œâ—Šâºâº;                     ;; Tier: Î´â‰¥0.75
âŠ¢wf:all_blocks_presentâˆ§properly_structured;
âŠ¢types:User,Request,Device,RiskScore,Decision,PolicyResult;
âŠ¢rules:12_policy_rules;
âŠ¢funcs:risk_score,enforce_policy,require_mfa,is_trusted;
âŠ¢proofs:6_theoremsâˆ;
âŠ¢logic:âˆ€r.(high_riskâˆ§Â¬trusted)â‡’mfa_required;
âŠ¢Ambig<0.02;
âŸ©
